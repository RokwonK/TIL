---
title: EC2
author: 김록원
date: 2022.12.26
category: AWS
---

# AWS EC2  

AWS 서비스를 이용하면서 가장 먼저 접하고 가장 많이 사용하는 서비스가 바로 EC2가 아닐까 싶다. 일반적으로 서버를 운용하기 위해 사용하지만 목적에 따라 많은 사양을 가지고 있고 상황에 따라 비용도 최소화 시킬 수 있는 방법도 제공해준다. EC2와 EC2와 열결되어 있는 여러 기능들에 대해 살펴보자  

<br />  

> **💡 EC2란?**  
Elastic Computed Cloud의 약자.  
AWS에 제공해주는 IaaS로 물리적인 하드웨어에 존재하는 Virtual Machine이다.  
가상 드라이브인 EBS, 트래픽 분산기능인 ELB, 스케일아웃을 위한 기능인 Auto Scaling Group 등과 함께 사용할 수 있다.  
또한 AWS의 수많은 관리형 서비스들은 EC2를 기반으로 만들어졌다.  

<br />

## EC2 기본개념

### EC2의 사양 선택
- OS : Linux, Window, Mac 중 선택 가능
- Compute power & cores(CPU) 선택 가능
- RAM의 양 선택 가능
- 용량 선택
  - Network-attached(EBS & EFS)
  - hardware(EC2 Instance Store)
- EC2에 연결할 네트워크 선택
  - Network Card(속도가 빠른 네트워크 카드?)
  - Public IP(어떤 종류의 공용 IP?)
- 방화벽 규칙 선택
  - security group(보안 그룹)
- Bootstrap script(시작 시 초기 설정)
  - EC2 User Data

### EC2 User Data
EC2 인스턴스를 부트스트래핑할 수 있다.  
bootstrapping이란 머신이 작동할때 명령을 시작하는 것을 말한다.  
첫 시작시에만 한 번 실행된다.  

부팅작업을 자동화하기 위해서 필요하다. 예를 들어
- 소프트웨어 설치, 업데이트, 인터넷에서 파일 다운로드 등
- 추가하면 추가할수록 할 일이 들어남
- 참고로 User Data는 루트 계정에서 실행된다. 즉 `sudo` 명령어를 꼭 붙여야한다.

### EC2 Instance type  
인스턴스 타입의 이름에는 규칙이 있다.
```txt
m5.2xlarge  
{instance class}{generation}.{instance class size}
```

generation : AWS 하드웨어가 계속 개선되고 있어서 새로운 세대의 하드웨어가 출시되면 버전없이 됨  
instance class size : size가 클 수록 더 많은 메모리와 CPU를 가짐  

EC2는 목적에 따라 타입이 나뉜다.  
**`General Purpose`**  
- 웹서버나 코드 저장소의 용도 등으로 사용
- 컴퓨팅 파워, 메모리, 네트워크 간의 균형이 잘 맞음


**`Compute Optimized`**  
- 높은 수행능력이 필요할때 사용한다.
- (데이터의 일괄처리, 머신러닝, 전용 게임서버 등)
- 인스턴스 타입 이름은 `C`로 시작한다.

**`Memory Optimized`**
- 메모리(RAM)에서 대규모 데이터셋을 처리하는 유형의 작업
- 고성능의 데이터베이스, 캐시 저장소, BI, 비정형 데이터를 실시간으로 처리하는 어플
- 인스턴스 타입 이름은 RAM을 뜻하는 `R`로(예외로 `X1` 등도 있음) 시작한다.  

**`Storage Optimized`**  
- 로컬 스토리지에서 대규모의 데이터셋에 액세스할 때 적합한 인스턴스
- OLTP 시스템, RDS, NoSQL, Redis, Data warehouse 어플, 분산 파일 시스템
- 인스턴스 타입 이름은 RAM을 뜻하는 `I`, `G`, `H1`으로 시작한다.  

[인스턴스 비교 사이트](https://instances.vantage.sh/)
[공식문서 링크](https://aws.amazon.com/ko/ec2/instance-types/)


### Security Group
EC2의 방화벽이라고 할 수 있다.  
- 네트워크 보안의 핵심이다.  
- EC2 인스턴스에 들어오고 나가는 트래픽을 제어한다.  
  - 포트를 허용한다.
  - 허용 규칙만을 포함한다.
  - 인바운드, 아웃바운드 규칙을 따로 지정할 수 있다
  - 아웃바운드는 기본적으로 모든 트래픽을 허용한다.
  - 인바운드는 기본적으로 모든 트래픽을 차단한다.
- IP 주소, 다른 보안 규칙을 참조해 규칙을 만든다.

하나의 보안그룹을 여러 인스턴스에 적용할 수 있다.  
보안그룹은 Region과 VPC에 종속되어 있다.  
보안그룹은 EC2 외부에 있다.(즉, 트래픽이 차단되면 EC2에서 로그를 확인할 수 없다.)  
SSH 액세스를 위해 하나의 별도 보안 그룹을 유지하는 것이 좋다.  

타임아웃, 무한 대기와 같은 문제가 발생하면 보안그룹때문에 발생하는 것이다  
연결 거부로깅이면 보안그룹 문제는 아니다.  

**보안그룹의 다른 보안그룹 참조**  
보안그룹이 인바운드 규칙으로 다른 보안그룹을 허용한다면  
해당 보안그룹을 가진 인스턴스들은 모두 접근가능하다(IP를 허용하지 않았어도!)  


### SSH  
SSH(Secure Shell) 명령줄 인터페이스 도구로 SSH 사용 가능  
SSH는 원격머신이나 서버를 Cli를 사용하여 제어할 수 있는 방법이다.  

IP를 이용해서 접근가능하다(물론 보안그룹에서 허용하고 있어야한다)  
key 파일을 이용해 접근할 수 있음(.pem 파일)  
key 파일을 처음 다운받았을때 파일권한이 너무 열려 있기 대문에 644 -> 400으로 바꿔줘야함
`ssh -i {key 파일} {ec2-user}@{IP} ` ec2-user는 사용자이름이다 `ec2-user`는 Amazon Linux2의 루트 사용자명이다.  



### EC2를 위한 IAM Role 적용해보기
EC2 인스턴스 내부에서 aws configure을 통해 상세 개인정보를 입력해두면 이 계정상의 누구라도 EC2 인스턴스 커넥트 등을 통해 접속할 수 있음.  
이때 IAM Role을 사용할 수 있음.  
역할을 만들고 `IAMReadOnlyAccess` 정책을 부여한다 -> EC2의 Security에서 해당 Role을 부여한다면 EC2 내부에서 aws cli를 이용해볼 수 있다.

[IAM 공부하러 가기]()  

<br /><hr><br />  

## EC2 구매 옵션
EC2 Instance를 운용하는데 다양한 옵션이 존재한다. 어떤 옵션을 선택하느냐에따라 운용가능한 시간, 가격이 달라진다.

On-Demand Instance : 잠시 사용할것, 예측가능한 가격
Reserved : 최소 1년 이상 사용해야 하는 약속형 인스턴스. 가격이 더 싸다. 3가지 종류가 있다.
- Reserved Instance : 데이터베이스처럼 장기적으로 사용할때
- Convertible Reserved Instance : 시간이 지난 후 다른 종류의 인스턴스로 바꿀 수 있는 유연형 인스턴스
- Scheduled Reserved Instance : 일년 내내 사용되지 않고 정해진 시간대에만 사용하는 것(현재는 사용되지 않음)
Spot Instance : 저렴한 단기간 사용 인스턴스, 소신 가능성이 있으며 신뢰성이 낮음
Dedicated Hosts : 물리적 서버 전체를 예약하고 인스턴스 배치를 제어한다

### EC2 On-Demand
사용한 만큼 지불하는 옵션
Linux, Window 머신은 비용이 초당으로 지불됨. 다른 OS는 시간당으로 청구됨  
가격은 높지만 선결제나, 장기 약정이 없음. 개발자 마음대로 생성, 삭제가 가능함.  
어플의 작동 방식을 예측할 수 없는 단기 작업을 실행할 경우 적합하다.  

### EC2 Reserved
Reserved Instance
- On-Demand와 비교하면 최대 75%의 비용을 절약할 수 있다.  
- 예약 기간이 있어 1년이나 3년(할인율 더 큼) 중에서 선택할 수 있다.  
- 또한 선결제 방식을 택할경우 더 큰 할인을 받을 수 있다.  
- 특정한 타입을 선택해야한다.  
- 애플이 안정된 상태로 운용해야하는 데이터베이스같은 곳에 사용할 수 있다.  

Convertible Reserved Instance
- 약정 시간이 지나면 EC2 타입을 변경할 수 있다.  
- 대신 할인율은 Reserved Instance에 비해 낮다(최대 54%)

Scheduled Reserved Instance
- 특정한 시간대에 인스턴스 실행
- 1,2,3년 단위로 계약한다.  

### EC2 Spot
- 가장 할인율이 높은 옵션이다.(약 90%) 
- 특정 조건이 지불하고자 하는 가격이 현재 스팟 인스턴스의 가격보다 낮으면 언제든지 인스턴스가 중단됨  
- 가장 비용 효율적이지만 작업 중단해도 문제가 없는 작업에만 사용이 가능하다.  
- 단발성 데이터분석, 이미지 프로세싱, 분산된 작업방식에 사용할 수 있다.

spot 비용은 offer나 용량에 따라 다양하다.  
2분의 유예기간이 있다. 인스턴스를 재시작, 혹은 완전히 종료  

`스팟블록`  
특정 기가동안 인스턴스를 차단하는 기능 인스턴스가 회수

`스팟 인스턴스의 종료`  
- 인스턴스 갯수, 최고가, AMI 등 요구되는 사양
- 스팟 인스턴스 1회성 요청과 사후 인스턴스를 위한 지속적인 요청이 있다.
  - 1회성 요청의 경우 인스턴스가 바로 실행 -> 스팟 요청이 사라짐
  - 지속적인 요청의 경우 인스턴스 중단이 일어나면 스팟 요청이 다시 전달된다.  
  - 요청을 취소한 후 스팟 인스턴스를 종료해야함

`스팟 Fleets(집합)`
- Spot 인스턴스와 선택적으로 On-Demand 인스턴스를 조합해 사용하는 방식
- 정의된 비용 제한 내에서 대상 용량을 맞추려 노력
- 사용가능한 런치풀(인스턴트 타입, OS, 가용영역 정의)을 통해서 실행됨. 다양한 타입, OS, 가용영역이 선택될 수 있다.
- 여러가지 런치풀을 정의해놓으면 플릿이 가장 적합하고 좋은 런치풀을 선택해준다.
- 정해진 예산, 원하는 용량에 도달하면 인스턴스 실행을 멈춤
- 스팟 인스턴스를 할당전략
  - lowestPrice : 가장 비용이 저렴한 런치풀로 인스턴스를 실행한다.  
  - diversified : 정의한 런치풀에 걸쳐 분산됨. 가용성이 좋음
  - capacityOptimized : 인스턴스의 개수에 따라 최적 용량으로 실행됨. 적절한 풀을 찾아주는 옵션

### EC2 Dedicated Hosts
- EC2 인스턴스를 갖춘 유저 중심의 물리적 서버
- 데이터 센터 내 하나의 서버 전체를 임대한다.
- 가장 비싼 EC2 구매옵션이다.
- 규정 준수요건과 서버 결합 소프트웨어 라이센스를 만족시켜줄 수 있다.
- 3년의 계약 기간동안 할당됨

### EC2 Dedicated Instances
- 우리의 전용 하드웨어에서 실행되는 EC2 인스턴스
- 하지만 EC2에서 전용 하드웨어로 접근은 불가능하다

<br /><hr><br />  

