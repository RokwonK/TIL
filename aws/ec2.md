---
title: EC2
author: 김록원
date: 2022.12.26
category: AWS
---

# AWS EC2  
AWS 서비스를 이용하면서 가장 먼저 접하고 가장 많이 사용하는 서비스가 바로 EC2가 아닐까 싶다. 일반적으로 서버를 운용하기 위해 사용하지만 목적에 따라 많은 사양을 가지고 있고 상황에 따라 비용도 최소화 시킬 수 있는 방법도 제공해준다. EC2와 EC2와 열결되어 있는 여러 기능들에 대해 살펴보자  

<br />  

> **💡 EC2란?**  
Elastic Computed Cloud의 약자.  
AWS에 제공해주는 IaaS로 물리적인 하드웨어에 존재하는 Virtual Machine이다.  
가상 드라이브인 EBS, 트래픽 분산기능인 ELB, 스케일아웃을 위한 기능인 Auto Scaling Group 등과 함께 사용할 수 있다.  
또한 AWS의 수많은 관리형 서비스들은 EC2를 기반으로 만들어졌다.  

<br />

## EC2 기본개념
EC2를 운용하기 위해서 필요한 기본 개념들이 존재한다.  
결국은 하나의 하드웨어를 운용하는 것이기 때문에 관련된 셋팅을 EC2를 대여하는 주체가 설정할 수가 있다. 물론 좋은 사양을 선택할수록 비용도 상승할 것이다.  

<br />  

### EC2의 사양 선택  
EC2를 구성하기 위해서 여러 선택사항들이 존재한다.  
- `OS` : Linux, Window, Mac 중 선택 가능
- `CPU` : Compute power & cores 선택 가능
- `RAM` : RAM의 크기 선택 가능
- `Storage`
  - EBS & EFS : Network-attached
  - EC2 Instance Store : hardware
- `방화벽 규칙 설정` : security group
- `Bootstrap script(시작 시 초기 설정)` : EC2 User Data

<br />  

### EC2 User Data
EC2 User Data란 EC2 인스턴스 실행 시 작동시킬 스크립트이다.  
EC2가 처음 실행될때 한 번만 실행된다.(bootstrapping)  
- 부팅작업을 자동화히기 위해서 사용한다.
- 소프트웨어 설치, 업데이트, 인터넷에서 파일 다운로드와 같은 작업을 할 수 있다.
- 참고로 User Data는 루트 계정에서 실행된다. 즉 `sudo` 명령어를 꼭 붙여야한다.  

EC2 인스턴스를 만들때 Advanced Detail 섹션에서 확인할 수 있다.
![User Data](https://user-images.githubusercontent.com/52196792/209640103-2f639462-8d00-45f9-9833-e147eef6908d.png)

<br />  

### EC2 Instance type  
인스턴스 타입의 이름에는 규칙이 있다.
`m5.2xlarge` 보통 이런 형식으로 각 자리가 의미를 가진다.  
`{instance class}{generation}.{instance class size}`  

`generation` : AWS 하드웨어가 계속 개선되고 있어서 새로운 세대의 하드웨어가 출시되면 버전없이 됨  
`instance class size` : size가 클 수록 더 많은 메모리와 CPU를 가짐  

<br />  

EC2는 목적에 따라 타입이 나뉜다. instance class는 목적과 관련이 깊다.  
**`General Purpose`**  
- 웹서버나 코드 저장소의 용도 등으로 사용
- 컴퓨팅 파워, 메모리, 네트워크 간의 균형이 잘 맞음  

<br />

**`Compute Optimized`**  
- 높은 수행능력(CPU 파워)이 필요할때 사용한다.
- 데이터의 일괄처리, 머신러닝, 전용 게임서버 등  
- 보통 instance class가 `C`이다.

<br />

**`Memory Optimized`**  
- 메모리(RAM)에서 대규모 데이터셋을 처리하는 유형의 작업
- 고성능의 데이터베이스, BI, 비정형 데이터를 실시간으로 처리하는 어플
- 보통 instance class가 RAM을 뜻하는 `R`(예외로 `X1` 등도 있음) 이다.  

<br />

**`Storage Optimized`**   
- 로컬 스토리지에서 대규모의 데이터셋에 액세스할 때 적합한 인스턴스
- OLTP 시스템, RDS, NoSQL, Redis, Data warehouse 어플, 분산 파일 시스템
- 보통 instance class가 `I`, `G`, `H1` 이다.  

[인스턴스 비교 사이트](https://instances.vantage.sh/)
[공식문서 링크](https://aws.amazon.com/ko/ec2/instance-types/)

<br />  

### Security Group
Security Group(보안 그룹)은 EC2의 방화벽이라고 할 수 있다.  
- 네트워크 보안의 핵심이다.  
- EC2 인스턴스로 들어오고 나가는 트래픽을 제어할 수 있다.
  - IP, 포트, Protocol을 이용하여 통제한다.
  - 허용 규칙만을 작성한다.
  - 인바운드(외부 -> EC2), 아웃바운드(EC2 -> 외부) 규칙을 따로 지정할 수 있다.
  - 아웃바운드는 기본적으로 모든 트래픽을 허용한다.
  - 인바운드는 기본적으로 모든 트래픽을 차단한다.
- IP 주소, 다른 보안 규칙을 참조해 규칙을 만든다.  

<br />

**`Security Group의 특징`**  
- 하나의 보안그룹을 여러 인스턴스에 적용할 수 있으며 그 반대도 가능하다.
- 보안그룹은 **Region과 VPC에 종속**되어 있다.  
- **보안그룹은 EC2 외부에 있다.**(즉, 트래픽이 차단되면 EC2에서 로그를 확인할 수 없다.)  

<br />

**`Security Group ++`**  
- SSH 액세스를 위해 하나의 별도 보안 그룹을 유지하는 것이 좋다.  
- 타임아웃, 무한 대기와 같은 문제가 발생하면 보안그룹때문에 발생하는 것이다  
- 연결 거부 문제는 보안그룹과 관련된 문제는 아니다.  

<br />

> **💡 보안그룹의 다른 보안그룹 참조**  
보안그룹이 인바운드 규칙으로 다른 보안그룹을 허용한다면  
해당 보안그룹을 가진 인스턴스들은 모두 접근가능하다(IP를 허용하지 않았어도!)  

<br />

### SSH  
SSH(Secure Shell) 명령줄 인터페이스 도구로 원격머신이나 서버를 Cli를 사용하여 제어할 수 있는 방법이다.  
즉, 우리의 컴퓨터에서 EC2로 원격접속을 할 수 있는 방법이다.  
SSH로 원격접속을 하기 위해선 대상이 되는 호스트의 IP와 접속을 위한 Key가 필요하다.  

<br />

> **💡 SSH 접근 시 Tip!**  
보안그룹의 인바운드 규칙에 SSH가 허용되어 있어야하며 접속하는 위치의 IP도 등록되어 있어야한다.  
뿐만아니라 AWS 콘솔에서 SSH접속을 위해 다운 받은 키(.pem)는 파일권한이 644로 굉장히 열려있다. 400으로 바꿔줘야 정상적으로 사용가능하다.  
`ssh -i {key 파일} {ec2-user}@{IP}` 명령어로 접속가능하다. @ 앞은 사용자이름이다. `ec2-user`는 Amazon Linux2의 루트 사용자명이다.  

<br />  

### EC2를 위한 IAM Role 적용해보기
EC2 인스턴스 내부에서 aws configure을 통해 상세 개인정보를 입력해두면 이 계정상의 누구라도 EC2 인스턴스 커넥트 등을 통해 접속할 수 있다.  
이때 IAM Role을 사용할 수 있다.  
역할을 만들고 `IAMReadOnlyAccess` 정책을 부여한다 -> EC2의 Security에서 해당 Role을 부여한다면 EC2 내부에서 aws cli를 이용해볼 수 있다.  

[IAM 공부하러 가기](https://velog.io/@rokwon_k/AWS-IAM-%EC%84%9C%EB%B9%84%EC%8A%A4)  

<br />  

### EC2의 장점  
사실상 클라우드를 사용하는 이유와 같다.  
직접 하드웨어를 구매하고 소프트웨어와 필요한 구성을 셋팅하는데 오랜 시간이 걸릴 것이다.  
또한 하드웨어를 사양을 바꾸게 된다면 같은 복잡한 절차와 비용또한 2배 이상을 소비할게 될 것이다. 
EC2는 하드웨어 구비, 소프트웨어 설치와 같은 시간을 비약적으로 줄여주며 사양 교체또한 매우 유연하다.  

<br /><hr><br />  

## EC2 구매 옵션
EC2 Instance를 운용하는데 다양한 옵션이 존재한다. 어떤 옵션을 선택하느냐에따라 운용가능한 시간, 가격이 달라진다.  
종류로는 `On-demand`, `Reserved`, `Spot`, `Dedicated`, `Dedicate`가 존재한다.  

<br />  

### EC2 On-Demand Instance
- 사용한 만큼 지불한다는 특징이 있다.(Linux, Window 머신은 비용이 초당으로 지불됨. 다른 OS는 시간당으로 청구됨)  
- 가격은 높지만 선결제나, 장기 약정이 없음. 개발자 마음대로 생성, 삭제가 가능하다.  
- 어플의 작동 방식을 예측할 수 없는 단기 작업을 실행할 경우 적합하다.  

<br />  

### EC2 Reserved Instance  
Reserved Instance는 내부에 다시 3가지 형태로 나뉜다.  

<br />

**`Standard Reserved Instance`**
- On-Demand와 비교하면 최대 75%의 비용을 절약할 수 있다.  
- 예약 기간이 있어 1년이나 3년(할인율 더 큼) 중에서 선택할 수 있다.  
- 또한 선결제 방식을 택할경우 더 큰 할인을 받을 수 있다.  
- 특정한 타입을 선택해야한다.  
- 애플이 안정된 상태로 운용해야하는 데이터베이스같은 곳에 사용할 수 있다.  

<br />

**`Convertible Reserved Instance`**
- 마찬가지로 1년 또는 3년 계약
- 계약 도중 EC2 타입을 변경할 수 있다.(유연함)  
- 대신 할인율은 Reserved Instance에 비해 낮다.(최대 54%)  

<br />

**`Scheduled Reserved Instance`**
- 특정한 시간대에 인스턴스 실행
- 1,2,3년 단위로 계약한다.  
- (현재는 사용하지 않는다)  

<br />  

### EC2 Spot Instance
가장 할인율이 높은 옵션이다.(약 90%) '지불하고자 하는 시간당 최고 가격'으로 인스턴스를 빌릴 수 있다. 지정한 가격보다 더 높아진다면 Spot Instance는 회수당한다는 단점이 존재한다. 이 때문에 중간이 작업이 중단되어도 문제가 없는 작업, 1~6시간의 워크로드를 다룰시에만 사용하는 것이 효율적이다. (ex. 단발성 데이터분석, 이미지 프로세싱, 분산된 작업방식)  
Spot은 block과 fleets 으로 나눌 수 있다.

<br />  

**`스팟 블록`**  
- 1~6시간 동안 예약하여 사용하는 방식이다.
- 이 방식은 중간에 회수당하지 않는다는 장점이 있다. 아주 드물게 용량 요구로 인해서 중단될 수 있다.
- 종료되기 2분 전에 종료 알림을 보내준다.

<br />

**`스팟 플릿`**
- '지불하고자 하는 시간당 최고 가격'을 지정하여 인스턴스를 빌린다
- 사용하고자 하는 인스턴스 타입, 갯수 요구사항 등을 지정할 수 있다
- 항상 지정한 용량을 유지하고자 한다.(인스턴스가 종료되면 용량을 채우기위해 새로운 인스턴스를 자동 재요청 한다는 뜻)
- 정해진 예산, 원하는 용량에 도달하면 인스턴스 실행을 멈춤

<br />  

> **💡 스팟 할당전략**  
lowestPrice : 가장 비용이 저렴한 런치풀로 인스턴스를 실행한다.  
diversified : 정의한 런치풀에 걸쳐 분산됨. 가용성이 좋음  
capacityOptimized : 인스턴스의 개수에 따라 최적 용량으로 실행됨. 적절한 풀을 찾아주는 옵션  

<br />  

> **💡 스팟 인스턴스의 종료**  
스팟 플릿은 수동으로 인스턴스를 종료하더라도 인스턴스를 자동재요청한다. 따라서 스팟 재요청을 취소한 다음 인스턴스를 종료시켜야한다. 

<br />  

### EC2 Dedicated

**`Dedicated Hosts`**
- 물리적 서버 전체를 예약하고 인스턴스 배치를 제어한다.
- 데이터 센터 내 하나의 서버 전체를 임대한다는 것
- 가장 비싼 EC2 구매옵션
- 어려운 규정 준수요건과 복잡한 서버 결합 소프트웨어 라이센스 조건을 만족시켜줄 수 있다는 장점이 있다.
- 계약 기간은 3년

<br />  

**`Dedicated Instance`**
- 사용자의 전용 하드웨어에서 실행되는 EC2 인스턴스

<br /><hr><br />  

## EC2 ++